<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ args[0] }} - Water Quality</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  {{ insert_from_path(path="/templates/page/page.html") }}
  
  <main>
    <div class="page-header">
      <h1>{{ args[0] }}</h1>
      <div class="breadcrumb">
        <a href="index.html">Home</a> â€º Water Quality Data
      </div>
    </div>
    
    <div id="time-picker"></div>
    <div id="charts"></div>
  </main>
  
  <script type="module">
    import { createTimePicker, timeState, queryData, Plot, plotName, legendName, timerange } from "./lib.js";
    
    // Data files from template
    const datafiles = {
    {%- for k2, v2 in export[args[0]] %}
      "{{ k2 }}": [
      {%- for v3 in v2.files %}
        { start_time: {{ v3.start_time }}, end_time: {{ v3.end_time }}, file: "{{ v3.file }}" },
      {%- endfor %}
      ],
    {%- endfor %}
    };
    
    // Chart configurations from template
    const chartConfigs = [
    {% for key, fields in group(by="name",in=export[args[0]][args[1]].schema.fields) %}
      {
        name: "{{ key }}",
        title: plotName("{{ key }}"),
        unit: "{{ fields[0].unit }}",
        marks: (data, begin, now) => [
        {%- for inst, ifields in group(by="instrument",in=fields) -%}
          {%- set field = ifields[0] -%}
          Plot.lineY(data, {x: "timestamp", y: "{{ field.instrument }}.{{ field.name }}.{{ field.unit }}.avg", stroke: () => legendName("{{ field.instrument }}", "{{ field.name }}", "{{ field.unit }}")}),
          {% if ifields | length > 1 -%}
          Plot.areaY(data, {x: "timestamp", y1: "{{ field.instrument }}.{{ field.name }}.{{ field.unit }}.min", y2: "{{ field.instrument }}.{{ field.name }}.{{ field.unit }}.max", fillOpacity: 0.3, fill: () => legendName("{{ field.instrument }}", "{{ field.name }}", "{{ field.unit }}")}),
          {% endif -%}
        {%- endfor -%}
        ]
      },
    {% endfor %}
    ];
    
    // Initialize
    const pickerContainer = document.getElementById("time-picker");
    const chartsContainer = document.getElementById("charts");
    
    createTimePicker(pickerContainer);
    
    // Render charts on time change
    timeState.subscribe(async (days) => {
      const data = await queryData(datafiles, days);
      chartsContainer.innerHTML = "";
      
      if (data.length === 0) {
        chartsContainer.innerHTML = `<div class="empty-state">No data for selected time range</div>`;
        return;
      }
      
      const now = Date.now();
      const begin = now - days * 24 * 3600 * 1000;
      const width = chartsContainer.clientWidth - 32;
      
      for (const config of chartConfigs) {
        const chartDiv = document.createElement("div");
        chartDiv.className = "chart";
        
        const plot = Plot.plot({
          title: config.title,
          width,
          x: { grid: true, type: "time", label: "Date", domain: [begin, now] },
          y: { grid: true, label: config.unit, zero: true },
          color: { legend: true },
          marks: config.marks(data, begin, now)
        });
        
        chartDiv.appendChild(plot);
        chartsContainer.appendChild(chartDiv);
      }
    });
  </script>
</body>
</html>
